<!doctype html>
<html lang="zh-Hant">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>超丐版 mo.co 活動預測</title>
  <style>
    :root {
      --bg: #0b0e14;
      --panel: #111827;
      --panel2: #0f172a;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --line: #1f2937;
      --chip: #0b1220;
      --chipline: #22314a;
      --ok: #22c55e;
      --warn: #f59e0b;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(17, 24, 39, .95), rgba(11, 14, 20, .95));
      position: sticky;
      top: 0;
      z-index: 10;
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 700;
    }

    .sub {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }

    .wrap {
      max-width: 1000px;
      margin: 0 auto;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
      align-items: center;
    }

    .controls>* {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    label {
      color: var(--muted);
      font-size: 12px;
    }

    input,
    select,
    button {
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 13px;
    }

    input[type="number"] {
      width: 92px;
    }

    input[type="datetime-local"] {
      width: 210px;
    }

    input[type="text"] {
      width: 240px;
    }

    button {
      cursor: pointer;
      background: #0b1220;
      border-color: var(--chipline);
    }

    button:hover {
      border-color: #334155;
    }

    main {
      padding: 14px 18px 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 880px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .card {
      border: 1px solid var(--line);
      background: rgba(17, 24, 39, .65);
      border-radius: 14px;
      overflow: hidden;
    }

    .cardhead {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(15, 23, 42, .8);
    }

    .time {
      font-weight: 700;
      font-size: 14px;
    }

    .meta {
      color: var(--muted);
      font-size: 12px;
    }

    .items {
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      background: rgba(11, 18, 32, .65);
      border: 1px solid rgba(34, 49, 74, .55);
      border-radius: 12px;
    }

    .event {
      font-weight: 650;
    }

    .map {
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--chipline);
      color: var(--muted);
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(34, 197, 94, .08);
      border: 1px solid rgba(34, 197, 94, .25);
      color: #86efac;
      font-size: 12px;
    }

    .warn {
      background: rgba(245, 158, 11, .08);
      border-color: rgba(245, 158, 11, .25);
      color: #fcd34d;
    }

    .footer {
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>超丐版 mo.co 活動預測</h1>
      <div class="sub">
        假設活動每 5 分鐘一批，並以 <span class="mono">20:50</span> 作為 5 小時（300 分鐘）循環的起點。所以只要官方一更新，這個超丐版☆預測網站就廢了。
      </div>

      <div class="controls">
        <div>
          <label for="hours">顯示範圍</label>
          <input id="hours" type="number" min="1" max="48" step="1" value="12" />
          <span class="chip">小時</span>
        </div>
        <div>
          <label for="baseTime">基準時間</label>
          <input id="baseTime" type="datetime-local" />
          <button id="useNow">用現在</button>
        </div>
        <div>
          <label for="q">搜尋</label>
          <input id="q" type="text" placeholder="事件或地圖關鍵字" />
          <button id="clearQ">清除</button>
        </div>
        <div>
          <label class="chip">台灣時間（Asia/Taipei）</label>
          <span id="nowLabel" class="pill"></span>
        </div>
      </div>
      <div class="footer">
        註：若某時段顯示 <span class="mono">X</span>，表示該槽位在提供的表中是空/無事件。
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="summary" class="sub" style="margin: 2px 0 12px 0;"></div>
      <div id="grid" class="grid"></div>
    </div>
  </main>

  <script>
    const SCHEDULE = { "cycle_minutes": 300, "slot_minutes": 5, "anchor_time": "20:50", "timezone": "Asia/Taipei", "slots": [{ "slot": 0, "time": "20:50", "items": [{ "event": "拯救戰術喵喵", "map": "孽生森林" }, { "event": "混沌騎士", "map": "下水道" }, { "event": "入侵警報", "map": "神聖花園" }, { "event": "混沌墮落精靈", "map": "腐化廣場" }, { "event": "混沌魚叉手", "map": "腐化碼頭" }] }, { "slot": 1, "time": "20:55", "items": [{ "event": "入侵警報", "map": "精靈洞穴" }, { "event": "拯救戰術喵喵", "map": "貓貓入侵" }, { "event": "雙倍經驗值", "map": "皇家營房" }, { "event": "混沌蟲夫人", "map": "腐化城堡地下室" }] }, { "slot": 2, "time": "21:00", "items": [{ "event": "重大研究", "map": "青翠廢墟" }, { "event": "混沌長矛跳跳龍", "map": "召喚庭院" }, { "event": "拯救戰術喵喵", "map": "城堡地下室" }, { "event": "重啟採集器", "map": "腐化下水道" }, { "event": "拯救戰術喵喵", "map": "腐化營房" }] }, { "slot": 3, "time": "21:05", "items": [{ "event": "好多嗅探犬", "map": "青翠廢墟" }, { "event": "高能警報", "map": "召喚庭院" }, { "event": "拯救戰術喵喵", "map": "城堡地下室" }, { "event": "混沌跳斧怪", "map": "腐化下水道" }, { "event": "入侵警報", "map": "腐化營房" }] }, { "slot": 4, "time": "21:10", "items": [{ "event": "X", "map": "X" }] }, { "slot": 5, "time": "21:15", "items": [{ "event": "入侵警報", "map": "孽生森林" }, { "event": "混沌警鐘", "map": "下水道" }, { "event": "混沌老媽", "map": "神聖花園" }, { "event": "雙倍經驗值", "map": "腐化廣場" }, { "event": "重大研究", "map": "腐化碼頭" }] }, { "slot": 6, "time": "21:20", "items": [{ "event": "拯救戰術喵喵", "map": "神殿村" }, { "event": "雙倍經驗值", "map": "城堡牆壁" }, { "event": "混沌衝擊怪-領袖", "map": "儀式廣場" }, { "event": "高能警報", "map": "霜掌碼頭" }, { "event": "混沌衝擊怪-領袖", "map": "腐化花園" }] }, { "slot": 7, "time": "21:25", "items": [{ "event": "X", "map": "X" }] }, { "slot": 8, "time": "21:30", "items": [{ "event": "拯救戰術喵喵", "map": "孽生森林" }, { "event": "入侵警報", "map": "下水道" }, { "event": "入侵警報", "map": "神聖花園" }, { "event": "重大研究", "map": "腐化廣場" }, { "event": "混沌箭頭", "map": "腐化碼頭" }] }, { "slot": 9, "time": "21:35", "items": [{ "event": "入侵警報", "map": "精靈洞穴" }, { "event": "高能警報", "map": "貓貓入侵" }, { "event": "混沌劇毒噴射怪", "map": "皇家營房" }, { "event": "混沌劇毒噴射怪", "map": "腐化城堡地下室" }] }, { "slot": 10, "time": "21:40", "items": [{ "event": "X", "map": "X" }] }, { "slot": 11, "time": "21:45", "items": [{ "event": "拯救戰術喵喵", "map": "神殿村" }, { "event": "混沌噴射怪", "map": "城堡牆壁" }, { "event": "混沌墮落精靈", "map": "儀式廣場" }, { "event": "混沌魚叉手", "map": "霜掌碼頭" }, { "event": "雙倍經驗值", "map": "腐化花園" }] }, { "slot": 12, "time": "21:50", "items": [{ "event": "雙倍經驗值", "map": "青翠廢墟" }, { "event": "好多嗅探犬", "map": "召喚庭院" }, { "event": "拯救戰術喵喵", "map": "城堡地下室" }, { "event": "混沌警鐘", "map": "腐化下水道" }, { "event": "高能警報", "map": "腐化營房" }] }, { "slot": 13, "time": "21:55", "items": [{ "event": "X", "map": "X" }] }, { "slot": 14, "time": "22:00", "items": [{ "event": "X", "map": "X" }] }, { "slot": 15, "time": "22:05", "items": [{ "event": "入侵警報", "map": "孽生森林" }, { "event": "重新啟動MO.BOTS", "map": "下水道" }, { "event": "好多嗅探犬", "map": "神聖花園" }, { "event": "工程師求助", "map": "腐化廣場" }, { "event": "拯救戰術喵喵", "map": "腐化碼頭" }] }, { "slot": 16, "time": "22:10", "items": [{ "event": "好多嗅探犬", "map": "精靈洞穴" }, { "event": "高能警報", "map": "貓貓入侵" }, { "event": "重新啟動MO.BOTS", "map": "皇家營房" }, { "event": "重新啟動MO.BOTS", "map": "腐化城堡地下室" }] }, { "slot": 17, "time": "22:15", "items": [{ "event": "重大研究", "map": "青翠廢墟" }, { "event": "混沌花朵", "map": "召喚庭院" }, { "event": "拯救戰術喵喵", "map": "城堡地下室" }, { "event": "雙倍經驗值", "map": "腐化下水道" }, { "event": "混沌蟲夫人", "map": "腐化營房" }] }, { "slot": 18, "time": "22:20", "items": [{ "event": "重啟採集器", "map": "神殿村" }, { "event": "混沌騎士", "map": "城堡牆壁" }, { "event": "拯救戰術喵喵", "map": "儀式廣場" }, { "event": "雙倍經驗值", "map": "霜掌碼頭" }, { "event": "拯救戰術喵喵", "map": "腐化花園" }] }, { "slot": 19, "time": "22:25", "items": [{ "event": "X", "map": "X" }] }, { "slot": 20, "time": "22:30", "items": [{ "event": "混沌鮮花", "map": "精靈洞穴" }, { "event": "拯救戰術喵喵", "map": "貓貓入侵" }, { "event": "雙倍經驗值", "map": "皇家營房" }, { "event": "雙倍經驗值", "map": "腐化城堡地下室" }] }, { "slot": 21, "time": "22:35", "items": [{ "event": "入侵警報", "map": "孽生森林" }, { "event": "雙倍經驗值", "map": "下水道" }, { "event": "雙倍經驗值", "map": "神聖花園" }, { "event": "重大研究", "map": "腐化廣場" }, { "event": "mo.co機械師", "map": "腐化碼頭" }] }, { "slot": 22, "time": "22:40", "items": [{ "event": "X", "map": "X" }] }, { "slot": 23, "time": "22:45", "items": [{ "event": "好多嗅探犬", "map": "青翠廢墟" }, { "event": "工程師求助", "map": "召喚庭院" }, { "event": "混沌吹吹怪", "map": "城堡地下室" }, { "event": "混沌跳斧怪", "map": "腐化下水道" }, { "event": "入侵警報", "map": "腐化營房" }] }, { "slot": 24, "time": "22:50", "items": [{ "event": "重啟採集器", "map": "神殿村" }, { "event": "重大研究", "map": "城堡牆壁" }, { "event": "雙倍經驗值", "map": "儀式廣場" }, { "event": "工程師求助", "map": "霜掌碼頭" }, { "event": "高能警報", "map": "腐化花園" }] }, { "slot": 25, "time": "22:55", "items": [{ "event": "X", "map": "X" }] }, { "slot": 26, "time": "23:00", "items": [{ "event": "入侵警報", "map": "青翠廢墟" }, { "event": "好多嗅探犬", "map": "召喚庭院" }, { "event": "雙倍經驗值", "map": "城堡地下室" }, { "event": "入侵警報", "map": "腐化下水道" }, { "event": "雙倍經驗值", "map": "腐化營房" }] }, { "slot": 27, "time": "23:05", "items": [{ "event": "拯救戰術喵喵", "map": "神殿村" }, { "event": "高能警報", "map": "城堡牆壁" }, { "event": "雙倍經驗值", "map": "儀式廣場" }, { "event": "混沌魚叉手", "map": "霜掌碼頭" }, { "event": "雙倍經驗值", "map": "腐化花園" }] }, { "slot": 28, "time": "23:10", "items": [{ "event": "重新啟動MO.BOTS", "map": "孽生森林" }, { "event": "重啟採集器", "map": "下水道" }, { "event": "拯救戰術喵喵", "map": "神聖花園" }, { "event": "工程師求助", "map": "腐化廣場" }, { "event": "mo.co機械師", "map": "腐化碼頭" }] }, { "slot": 29, "time": "23:15", "items": [{ "event": "X", "map": "X" }] }, { "slot": 30, "time": "23:20", "items": [{ "event": "混沌鮮花", "map": "精靈洞穴" }, { "event": "混沌箭頭", "map": "貓貓入侵" }, { "event": "重新啟動MO.BOTS", "map": "皇家營房" }, { "event": "雙倍經驗值", "map": "腐化城堡地下室" }] }, { "slot": 31, "time": "23:25", "items": [{ "event": "X", "map": "X" }] }, { "slot": 32, "time": "23:30", "items": [{ "event": "雙倍經驗值", "map": "神殿村" }, { "event": "高能警報", "map": "城堡牆壁" }, { "event": "高能警報", "map": "儀式廣場" }, { "event": "混沌魚叉手", "map": "霜掌碼頭" }, { "event": "工程師求助", "map": "腐化花園" }] }, { "slot": 33, "time": "23:35", "items": [{ "event": "X", "map": "X" }] }, { "slot": 34, "time": "23:40", "items": [{ "event": "好多嗅探犬", "map": "孽生森林" }, { "event": "雙倍經驗值", "map": "下水道" }, { "event": "重啟採集器", "map": "神聖花園" }, { "event": "mo.co機械師", "map": "腐化廣場" }, { "event": "高能警報", "map": "腐化碼頭" }] }, { "slot": 35, "time": "23:45", "items": [{ "event": "雙倍經驗值", "map": "青翠廢墟" }, { "event": "雙倍經驗值", "map": "召喚庭院" }, { "event": "好多嗅探犬", "map": "城堡地下室" }, { "event": "入侵警報", "map": "腐化下水道" }, { "event": "重啟採集器", "map": "腐化營房" }] }, { "slot": 36, "time": "23:50", "items": [{ "event": "工程師求助", "map": "精靈洞穴" }, { "event": "雙倍經驗值", "map": "貓貓入侵" }, { "event": "高能警報", "map": "皇家營房" }, { "event": "高能警報", "map": "腐化城堡地下室" }] }, { "slot": 37, "time": "23:55", "items": [{ "event": "X", "map": "X" }] }, { "slot": 38, "time": "00:00", "items": [{ "event": "X", "map": "X" }] }, { "slot": 39, "time": "00:05", "items": [{ "event": "X", "map": "X" }] }, { "slot": 40, "time": "00:10", "items": [{ "event": "工程師求助", "map": "神殿村" }, { "event": "清道夫群集", "map": "城堡牆壁" }, { "event": "拯救戰術喵喵", "map": "儀式廣場" }, { "event": "重新啟動MO.BOTS", "map": "霜掌碼頭" }, { "event": "好多嗅探犬", "map": "腐化花園" }] }, { "slot": 41, "time": "00:15", "items": [{ "event": "雙倍經驗值", "map": "青翠廢墟" }, { "event": "雙倍經驗值", "map": "召喚庭院" }, { "event": "工程師求助", "map": "城堡地下室" }, { "event": "高能警報", "map": "腐化下水道" }, { "event": "混沌船長", "map": "腐化營房" }] }, { "slot": 42, "time": "00:20", "items": [{ "event": "雙倍經驗值", "map": "精靈洞穴" }, { "event": "雙倍經驗值", "map": "貓貓入侵" }, { "event": "高能警報", "map": "皇家營房" }, { "event": "高能警報", "map": "腐化城堡地下室" }] }, { "slot": 43, "time": "00:25", "items": [{ "event": "重新啟動MO.BOTS", "map": "孽生森林" }, { "event": "混沌衝鋒怪", "map": "下水道" }, { "event": "高能警報", "map": "神聖花園" }, { "event": "mo.co機械師", "map": "腐化廣場" }, { "event": "雙倍經驗值", "map": "腐化碼頭" }] }, { "slot": 44, "time": "00:30", "items": [{ "event": "拯救戰術喵喵", "map": "精靈洞穴" }, { "event": "高能警報", "map": "貓貓入侵" }, { "event": "拯救戰術喵喵", "map": "皇家營房" }, { "event": "工程師求助", "map": "腐化城堡地下室" }] }, { "slot": 45, "time": "00:35", "items": [{ "event": "重新啟動MO.BOTS", "map": "青翠廢墟" }, { "event": "重新啟動MO.BOTS", "map": "召喚庭院" }, { "event": "混沌吹吹怪", "map": "城堡地下室" }, { "event": "混沌跳斧怪", "map": "腐化下水道" }, { "event": "mo.co機械師", "map": "腐化營房" }] }, { "slot": 46, "time": "00:40", "items": [{ "event": "雙倍經驗值", "map": "孽生森林" }, { "event": "混沌噴射怪", "map": "下水道" }, { "event": "雙倍經驗值", "map": "神聖花園" }, { "event": "mo.co機械師", "map": "腐化廣場" }, { "event": "mo.co機械師", "map": "腐化碼頭" }] }, { "slot": 47, "time": "00:45", "items": [{ "event": "X", "map": "X" }] }, { "slot": 48, "time": "00:50", "items": [{ "event": "好多嗅探犬", "map": "神殿村" }, { "event": "雙倍經驗值", "map": "城堡牆壁" }, { "event": "入侵警報", "map": "儀式廣場" }, { "event": "mo.co機械師", "map": "霜掌碼頭" }, { "event": "混沌老媽", "map": "腐化花園" }] }, { "slot": 49, "time": "00:55", "items": [{ "event": "X", "map": "X" }] }, { "slot": 50, "time": "01:00", "items": [{ "event": "混沌鮮花", "map": "精靈洞穴" }, { "event": "混沌箭頭", "map": "貓貓入侵" }, { "event": "混沌劇毒噴射怪", "map": "皇家營房" }, { "event": "混沌劇毒噴射怪", "map": "腐化城堡地下室" }] }, { "slot": 51, "time": "01:05", "items": [{ "event": "重啟採集器", "map": "青翠廢墟" }, { "event": "混沌碎骨怪", "map": "召喚庭院" }, { "event": "入侵警報", "map": "城堡地下室" }, { "event": "重新啟動MO.BOTS", "map": "腐化下水道" }, { "event": "重大研究", "map": "腐化營房" }] }, { "slot": 52, "time": "01:10", "items": [{ "event": "重新啟動MO.BOTS", "map": "神殿村" }, { "event": "雙倍經驗值", "map": "城堡牆壁" }, { "event": "雙倍經驗值", "map": "儀式廣場" }, { "event": "重啟採集器", "map": "霜掌碼頭" }, { "event": "混沌冰霜破壞獸", "map": "腐化花園" }] }, { "slot": 53, "time": "01:15", "items": [{ "event": "X", "map": "X" }] }, { "slot": 54, "time": "01:20", "items": [{ "event": "X", "map": "X" }] }, { "slot": 55, "time": "01:25", "items": [{ "event": "工程師求助", "map": "孽生森林" }, { "event": "入侵警報", "map": "下水道" }, { "event": "重大研究", "map": "神聖花園" }, { "event": "重新啟動MO.BOTS", "map": "腐化廣場" }, { "event": "雙倍經驗值", "map": "腐化碼頭" }] }, { "slot": 56, "time": "01:30", "items": [{ "event": "X", "map": "X" }] }, { "slot": 57, "time": "01:35", "items": [{ "event": "入侵警報", "map": "神殿村" }, { "event": "清道夫群集", "map": "城堡牆壁" }, { "event": "拯救戰術喵喵", "map": "儀式廣場" }, { "event": "雙倍經驗值", "map": "霜掌碼頭" }, { "event": "高能警報", "map": "腐化花園" }] }, { "slot": 58, "time": "01:40", "items": [{ "event": "雙倍經驗值", "map": "青翠廢墟" }, { "event": "混沌狂怒獸", "map": "召喚庭院" }, { "event": "拯救戰術喵喵", "map": "城堡地下室" }, { "event": "混沌吹吹怪", "map": "腐化下水道" }, { "event": "混沌劇毒噴射怪", "map": "腐化營房" }] }, { "slot": 59, "time": "01:45", "items": [{ "event": "X", "map": "X" }] }] };

    function pad2(n) { return String(n).padStart(2, '0'); }

    function taipeiNowDate() {
      // 以 Intl 取得台北時間的年月日、時分
      const parts = new Intl.DateTimeFormat('sv-SE', {
        timeZone: 'Asia/Taipei',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      }).formatToParts(new Date());
      const get = (t) => parts.find(p => p.type === t)?.value;
      const y = get('year'), mo = get('month'), d = get('day');
      const h = get('hour'), mi = get('minute'), s = get('second');
      // sv-SE 的格式 parts 可直接拼成 ISO-like
      return {
        y: +y, mo: +mo, d: +d, h: +h, mi: +mi, s: +s,
        isoLocal: `${y}-${mo}-${d}T${h}:${mi}`
      };
    }

    function toTaipeiParts(dateObj) {
      const parts = new Intl.DateTimeFormat('sv-SE', {
        timeZone: 'Asia/Taipei',
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      }).formatToParts(dateObj);
      const get = (t) => parts.find(p => p.type === t)?.value;
      return {
        y: +get('year'), mo: +get('month'), d: +get('day'),
        h: +get('hour'), mi: +get('minute')
      };
    }

    function taipeiDateFromLocalInput(value) {
      // datetime-local 的 value 代表使用者本機時區；這裡希望把它視為「台北時間」
      // 做法：解析字串成 y,m,d,h,mi，然後轉成一個以 UTC 表示的 Date（等效固定 offset +08:00）
      if (!value) return null;
      const [datePart, timePart] = value.split('T');
      const [y, mo, d] = datePart.split('-').map(Number);
      const [h, mi] = timePart.split(':').map(Number);
      // 台北固定 +08:00（不使用 DST）
      const utcMs = Date.UTC(y, mo - 1, d, h - 8, mi, 0);
      return new Date(utcMs);
    }

    function ceilToNext5Min(dateObj) {

      // 以台北時間為基準做進位到下一個 5 分鐘邊界
      const p = toTaipeiParts(dateObj);
      let totalMin = p.h * 60 + p.mi;
      const mod = totalMin % SCHEDULE.slot_minutes;
      if (mod !== 0) totalMin += (SCHEDULE.slot_minutes - mod);
      // 回轉為 Date (UTC 表示)
      const y = p.y, mo = p.mo, d = p.d;
      const hh = Math.floor(totalMin / 60) % 24;
      const mm = totalMin % 60;
      // 若 totalMin >= 1440，需要加一天
      const dayCarry = Math.floor(totalMin / 1440);
      const utcMs = Date.UTC(y, mo - 1, d + dayCarry, hh - 8, mm, 0);
      return new Date(utcMs);
    }

    function floorTo5Min(dateObj) {
      // 以台北時間為基準做截斷到當前 5 分鐘邊界（含正在發生的槽位）
      const p = toTaipeiParts(dateObj);
      let totalMin = p.h * 60 + p.mi;
      const mod = totalMin % SCHEDULE.slot_minutes;
      totalMin -= mod;
      const y = p.y, mo = p.mo, d = p.d;
      const hh = Math.floor(totalMin / 60) % 24;
      const mm = totalMin % 60;
      const dayCarry = Math.floor(totalMin / 1440);
      const utcMs = Date.UTC(y, mo - 1, d + dayCarry, hh - 8, mm, 0);
      return new Date(utcMs);
    }

    function slotIndexForTaipeiHM(h, m) {
      // anchor_time 是台北時間
      const [ah, am] = SCHEDULE.anchor_time.split(':').map(Number);
      const anchorMin = ah * 60 + am;
      const curMin = h * 60 + m;
      const diff = ((curMin - anchorMin) % SCHEDULE.cycle_minutes + SCHEDULE.cycle_minutes) % SCHEDULE.cycle_minutes;
      return Math.floor(diff / SCHEDULE.slot_minutes);
    }

    function addMinutesTaipei(dateObj, addMin) {
      const p = toTaipeiParts(dateObj);
      // 用 UTC 做加法後再顯示時區，不直接處理月末等問題
      return new Date(dateObj.getTime() + addMin * 60 * 1000);
    }

    function fmtTaipei(dateObj) {
      const p = toTaipeiParts(dateObj);
      return `${p.y}-${pad2(p.mo)}-${pad2(p.d)} ${pad2(p.h)}:${pad2(p.mi)}`;
    }

    function buildForecast(baseDate, hours, query) {
      const start = floorTo5Min(baseDate);
      const steps = Math.floor((hours * 60) / SCHEDULE.slot_minutes);
      const out = [];
      for (let i = 0; i < steps; i++) {
        const t = addMinutesTaipei(start, i * SCHEDULE.slot_minutes);
        const p = toTaipeiParts(t);
        const idx = slotIndexForTaipeiHM(p.h, p.mi);
        const slot = SCHEDULE.slots[idx];
        const items = slot.items || [];
        out.push({ t, idx, items });
      }

      // filter
      const q = (query || '').trim().toLowerCase();
      const filtered = out.map(x => {
        if (!q) return x;
        const keep = x.items.filter(it => (it.event || '').toLowerCase().includes(q) || (it.map || '').toLowerCase().includes(q));
        return { ...x, items: keep };
      });

      return { start, rows: filtered };
    }

    function render() {
      // header now label
      const nowP = taipeiNowDate();
      document.getElementById('nowLabel').textContent = `${nowP.y}-${pad2(nowP.mo)}-${pad2(nowP.d)} ${pad2(nowP.h)}:${pad2(nowP.mi)}:${pad2(nowP.s)}`;

      const hours = Math.max(1, Math.min(48, parseInt(document.getElementById('hours').value || '12', 10)));
      const q = document.getElementById('q').value || '';
      const baseInput = document.getElementById('baseTime').value;
      const baseDate = baseInput ? taipeiDateFromLocalInput(baseInput) : new Date(Date.UTC(nowP.y, nowP.mo - 1, nowP.d, nowP.h - 8, nowP.mi, 0));

      const result = buildForecast(baseDate, hours, q);
      const grid = document.getElementById('grid');
      const nowDate = new Date(Date.UTC(nowP.y, nowP.mo - 1, nowP.d, nowP.h - 8, nowP.mi, nowP.s));
      grid.innerHTML = '';

      let totalShown = 0;
      for (const row of result.rows) {
        // 若搜尋條件下沒有任何事件，仍保留時間卡（便於定位），但改用 warning 外觀
        const hasItems = row.items.length > 0 && !(row.items.length === 1 && row.items[0].event === 'X' && row.items[0].map === 'X');
        totalShown += row.items.filter(it => !(it.event === 'X' && it.map === 'X')).length;

        const card = document.createElement('div');
        card.className = 'card';
        const head = document.createElement('div');
        head.className = 'cardhead';

        const time = document.createElement('div');
        time.className = 'time';
        time.textContent = fmtTaipei(row.t);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `slot <span class="mono">#${row.idx}</span> / 60`;

        head.appendChild(time);
        // 進行中標記：row.t <= now < row.t + 5min
        const endT = addMinutesTaipei(row.t, SCHEDULE.slot_minutes);
        if (row.t.getTime() <= nowDate.getTime() && nowDate.getTime() < endT.getTime()) {
          const live = document.createElement('span');
          live.className = 'pill';
          live.textContent = '進行中';
          time.appendChild(document.createTextNode(' '));
          time.appendChild(live);
        }
        head.appendChild(meta);

        const itemsDiv = document.createElement('div');
        itemsDiv.className = 'items';

        if (row.items.length === 0) {
          const pill = document.createElement('span');
          pill.className = 'pill warn';
          pill.textContent = '此時間在搜尋條件下無符合事件';
          itemsDiv.appendChild(pill);
        } else {
          for (const it of row.items) {
            const r = document.createElement('div');
            r.className = 'row';
            const left = document.createElement('div');
            left.className = 'event';
            left.textContent = it.event;

            const right = document.createElement('div');
            right.className = 'map';
            right.textContent = it.map;

            r.appendChild(left);
            r.appendChild(right);
            itemsDiv.appendChild(r);
          }
        }

        card.appendChild(head);
        card.appendChild(itemsDiv);
        grid.appendChild(card);
      }

      const summary = document.getElementById('summary');
      summary.textContent = `基準時間：${fmtTaipei(baseDate)}（向下對齊目前 5 分鐘槽位：${fmtTaipei(result.start)}，含正在發生）｜範圍：${hours} 小時｜顯示事件筆數（不含 X）：${totalShown}`;
    }

    // wiring
    document.getElementById('useNow').addEventListener('click', () => {
      const p = taipeiNowDate();
      document.getElementById('baseTime').value = p.isoLocal;
      render();
    });
    document.getElementById('clearQ').addEventListener('click', () => {
      document.getElementById('q').value = '';
      render();
    });
    document.getElementById('hours').addEventListener('input', render);
    document.getElementById('baseTime').addEventListener('change', render);
    document.getElementById('q').addEventListener('input', () => {
      // debounce light
      window.clearTimeout(window.__t);
      window.__t = window.setTimeout(render, 120);
    });

    // init base time to now (Taipei)
    (() => {
      const p = taipeiNowDate();
      document.getElementById('baseTime').value = p.isoLocal;
      render();
      // refresh now label every second; forecast every 30s
      setInterval(() => {
        const nowP = taipeiNowDate();
        document.getElementById('nowLabel').textContent = `${nowP.y}-${pad2(nowP.mo)}-${pad2(nowP.d)} ${pad2(nowP.h)}:${pad2(nowP.mi)}:${pad2(nowP.s)}`;
      }, 1000);
      setInterval(render, 30000);
    })();
  </script>
</body>

</html>